{% extends 'global/base.html' %}
{% load static %}

{% block content %}
<h1 class="mt-4 text-center">Produtos</h1>
<div class="container">
    <div class="row justify-content-md-center">
        <div class="col-md-auto">
            <h3>Adicione Produtos</h3>
            <form id="formProdutudo" action="">
                {% comment %} <div class="form-group">
                    <input class="form-control" type="text" name="name" placeholder="Name" required>
                </div>
                <div class="form-group">
                    <input class="form-control" type="text" name="address" placeholder="Address" required>
                </div>
                <div class="form-group">
                    <input class="form-control" type="number" name="age" min="10" max="100" placeholder="Age" required>
                </div> {% endcomment %}
                {% csrf_token %}
                {{ form.as_p }}

                {{ form_fornecedor_preco.management_form }}

                <div id="formFornecedorPreco">
                    {% for fp in form_fornecedor_preco %}
                    <hr>
                    {{ fp }}
                    {% endfor %}
                </div>

                <button class="btn btn-primary form-control mt-2" type="submit">SUBMIT</button>
            </form>
        </div>
    </div>
    <div class="row mt-5">
        <div class="col">
            <table id="userTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Nome</th>
                        <th>Descrição</th>
                        <th>Categoria</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tabela">

                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Modal -->
<!-- <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="myModalLabel">Atualizar Produto</h4>
            </div>
            <form id="updateUser" action="">
                <div class="modal-body">
                    {% csrf_token %}

                    <input class="form-control" id="form-id" type="hidden" name="formId" />

                    {{ form.as_p }}

                    {{ form_fornecedor_preco.management_form }}

                    <div id="formFornecedorPreco">
                        {% for fp in form_fornecedor_preco %}
                        <hr>
                        {{ fp }}
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save changes</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>

            </form>
        </div>
    </div>
</div> -->
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateUser" action="">
                    <div class="modal-body">
                        {% csrf_token %}

                        <input class="form-control" id="form-id" type="hidden" name="formId" />

                        {{ form.as_p }}

                        {{ form_fornecedor_preco.management_form }}

                        <div id="formFornecedorPreco">
                            {% for fp in form_fornecedor_preco %}
                            <hr>
                            {{ fp }}
                            {% endfor %}
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block script %}
<script>
    function appendToTable(element) {
        // onClick="editUser(${element.id})" 
        var linha = document.getElementById("tabela");
        conteudo = `<tr id="produto-${element.id}">
                            <td class="produtoId">${element.id}</td>
                            <td class="produtoNome">${element.nome}</td>
                            <td class="produtoDescricao">${element.descricao}</td>
                            <td class="produtoCategoriaId" hidden>${element.categoria}</td>
                            <td class="produtoCategoria" >${element.categoria_name}</td>
                            <td>
                                <div class="row">
                                    <div class="col">
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal" onClick="editUser(${element.id})">
                                        Editar
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button type="button" class="btn btn-danger" onClick="deleteUser(${element.id})">DELETE</button>
                                    </div>
                                </div>
                            </td>
                        </tr>`
        linha.innerHTML += conteudo
    }
    // Lista os Produtos
    $.ajax({
        url: "{% url 'estoque:produtos-api-list' %}",
        type: 'GET',
        success: function (resposta) {
            resposta.forEach(element => {
                appendToTable(element);
            })
        },
    })

    //  Criar Produto
    const table = document.getElementById("tabela");
    const form = document.getElementById('formProdutudo');

    const nome = document.getElementById('id_nome');
    const descricao = document.getElementById('id_descricao');
    const categoria = document.getElementById('id_categoria');

    const csrf = document.getElementsByName('csrfmiddlewaretoken')

    const form_fornecedor_preco = document.getElementById('formFornecedorPreco')

    const url = "{% url 'estoque:produtos-api-list' %}"

    form.addEventListener('submit', e => {
        e.preventDefault()

        const fd = new FormData()
        fd.append('csrfmiddlewaretoken', csrf[0].value)
        fd.append('nome', nome.value)
        fd.append('descricao', descricao.value)
        fd.append('categoria', categoria.value)

        $.ajax({
            type: 'POST',
            url: url,
            data: fd,
            success: function (resposta) {
                appendToTable(resposta);
            },
            error: function (error) {
                const respostaErrors = error.responseJSON
                console.log(error)
                console.log(respostaErrors)
            },
            cache: false,
            contentType: false,
            processData: false,
        })
    })

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        };
        return cookieValue;
    };
    const csrftoken = getCookie('csrftoken');

    // Deletar Produto
    function deleteUser(id) {
        const url = '{% url "estoque:produtos-api-detail" 0 %}'.replace('0', id);

        var action = confirm("Are you sure you want to delete this user?");
        if (action != false) {
            $.ajax({
                type: 'DELETE',
                url: url,
                headers: { 'X-CSRFToken': csrftoken },
                mode: 'same-origin',
                success: function (resposta) {
                    console.log(resposta)
                    $("#userTable #produto-" + id).remove();
                },
                error: function (error) {
                    const respostaErrors = error.responseJSON
                    console.log(error)
                    console.log(respostaErrors)
                },
                cache: false,
                contentType: false,
                processData: false,
            })
        }
    };

    // Editar produto

    $("form#updateUser").submit(function () {
        const id_form = document.getElementById('form-id');
        const nome = document.getElementById('id_nome');
        const descricao = document.getElementById('id_descricao');
        const categoria = document.getElementById('id_categoria');

        const csrf = document.getElementsByName('csrfmiddlewaretoken')

        const url = '{% url "estoque:produtos-api-detail" 0 %}'.replace('0', id_form);

        form.addEventListener('submit', e => {
            e.preventDefault()

            const fd = new FormData()
            fd.append('csrfmiddlewaretoken', csrf[0].value)
            fd.append('nome', nome.value)
            fd.append('descricao', descricao.value)
            fd.append('categoria', categoria.value)


        });
        // $('form#updateUser').trigger("reset");
        // $('#myModal').modal('hide');
    });

    function editUser(id) {
        if (id) {
            tr_id = "#produto-" + id;
            const nome = $(tr_id).find(".produtoNome").text();
            const descricao = $(tr_id).find(".produtoDescricao").text();
            const categoria = $(tr_id).find(".produtoCategoriaId").text();
            console.log(nome, descricao, categoria)
            $('#form-id').val(id);
            $('#id_nome').val(nome);
            $('#id_descricao').val(descricao);
            $('#id_categoria').val(categoria);
        }
    }

</script>
{% endblock script %}